[Secure Coding Guide 原文链接](https://developer.apple.com/library/content/documentation/Security/Conceptual/SecureCodingGuide/Introduction.html#//apple_ref/doc/uid/TP40002415)

# 简介
## 安全编码指南简介

安全编码是一种编写软件中的实践，它是为了抵抗恶意或恶作剧的人或者程序的攻击。一个不安全的程序能够提供给攻击者入口来控制一台服务器或者用户的电脑，从拒绝单一用户的服务攻击，到安全妥协，丢失服务以及损坏数千用户的系统。安全编码帮助保护用户的数据被偷窃或破坏。  
安全编码对于所有的软件都很重要，小到你编写的一段脚本，大到商业级的应用。如果你编写的是软件的话，要熟悉了解这个文档中的信息。

### 概览

安全并非某种能够在事后添加到软件中的东西。就像是一个卡片做的盾牌无法通过添加一把锁头来锁住门保证安全一样，一个不安全的工具或应用可能需要大量的重新设计保证安全。你必须判断对于你的软件的危险类型，并贯彻始终在开发过程中加入安全编码。本书描述了缺陷的特定类型并给出了编码硬化技术的指南来对其进行修复。

#### 黑客和攻击者

与媒体报道中常提到的方式相反，在计算机领域，黑客其实指代的是专家程序员——一个喜欢研究复杂代码或操作系统的人。通常来讲，黑客并不带有恶意。当大部分的黑客查找到安全漏洞时，他们会通知负责该代码的公司或组织以便能够修复问题。不过，不幸的是，一小部分黑客会利用漏洞来攻击，并发布这些给其他用户来使用。  
攻击者通常对于盗取钱财，身份和其他私人秘密信息所驱动；它们的雇主或它们自己使用的所有机密；或者不友善的政府或恐怖组织使用。某些侵入应用或操作系统只是要告诉你它们可以这么做。其他的会谋求真实的破坏。由于攻击能够被自动化并且可复制，所有的弱点，无论多么微小，都会造成实际的威胁。

#### 没有平台是免疫的

macOS 和 iOS 在抵抗攻击方面都有着很好的记录。起初基于类似 BSD 的开源软件进行构建，并通过多年的类似代码签名和应用沙盒等技术加固，macOS 提供了多层防御。iOS 甚至通过给所有的应用严格限制沙盒提供了额外的安全。此外，Apple 积极审查其所有平台的漏洞，并定期发布可下载的安全更新。  
这是好消息。坏消息是应用和操作系统始终在被攻击。每天，攻击者都会查找新的漏洞，以及利用它们的方法。更进一步，在更大的范围，不需要广泛的攻击造成金钱和其他损失；如果将有价值的信息置于危险之中，则耽搁受感染的应用程序就足够了。虽然病毒或蠕虫的主要攻击在媒体中获取了大量的关注，数据的危机和毁灭对于普通用户而言才是最重要的。因此认真的对待每个安全风险，并快速的确定问题是很重要的工作。

### 如何使用本文档

首先，让你自己熟悉一下《安全概览》中的概念。  
本文档。  
其他的章节。  

- 《避免缓冲溢出和下溢》描述了缓冲溢出的几种类型并解释了如何避免。
- 《非法输入和进程间通信》讨论了你该如何验证每种从不可信任的源头到你的程序中的输入。
- 《种类条件和安全的文件操作》解释了种类条件是如何发生的，讨论了如何避免它，并描述了不安全和安全的文件操作。
- 《提高权限的安全性》
- 《设计安全的用户界面》
- 《设计安全的帮助者和守护者》便捷的任务列表，你可以在开发应用过程中用它，附录《第三方软件安全指南》给第三方应用提供了一个指南。

附录《安全开发检查表》提供了一个快捷任务列表，你应该在发布一款应用之前检查一遍，附录《第三方软件安全指南》为第三方应用绑定 macOS 提供了一个指南列表。

### 另请参阅

本文档聚焦于安全上易受攻击和使用 macOS 或 iOS 的开发者所特殊关注的编程实践。更多通用的处理方法，参见以下书籍和文档：  

- 参见 Viega 和 McGraw《构建安全的软件》Addison Wesley，2002；了解常见的安全编程讨论，尤其是它相关的 C 编程和编写脚本。
- 参见 Wheeler《安全编程 HOWTO》，在 http://www.dwheeler.com/secure-programs/ 网站上可见；了解几种易受攻击的安全问题类型和基于 UNIX 操作系统的编程指南，大部分都可以应用在 macOS 上。
- 参见 Cranor 和 Garfinkel《安全和可用：设计用户可用的安全的系统》O’Reilly，2005；了解编写用户界面提高安全性的相关信息。

有关安全相关的文档和应用编程接口（APIs），参见以下文档：  

- 有关安全网络的相关信息，参见《安全传输参考》。
- 有关 macOS 校验和验证的 APIs 相关信息，参见《校验服务 C 参考》和《安全基础框架参考》。
- 如果你在使用数码证书来教研，参见《证书，密钥和可信任的服务参考》。
- 有关密码的安全存储和其他秘密，刹那间《钥匙串服务参考》。

有关在 web 应用设计中的安全相关信息，浏览 http://www.owasp.org/。

# 安全上易受攻击的类型

## 缓冲溢出

## 非法输入

## 种类判断

## 进程间通信

## 不安全的文件操作

## 访问控制问题

## 安全存储和加密

## 社会工程

# 避免缓冲溢出和算数溢出

# 校验输入和进程间通信

# 条件判断和安全的文件操作

## 避免条件判断

## 安全信号处理

## 安全文件操作

# 提高权限的安全性

## 状态需要提高权限

## 在危险环境和最小化权限原则

## 避免提高权限

## 提高权限运行

## 调用改变权限等级

## 避免交叉权限过程

## 其他机制的限制和风险

# 设计安全的用户界面

## 使用安全默认

## 满足用户对安全的期望

## 坚固所有接口

## 在安全的位置放置文件

## 让安全选择更清晰

## 对抗社工攻击

## 尽可能使用安全的接口

# 设计安全的帮助者和守护者

## 使用应用沙盒

# 避免注入攻击和 XSS

## 避免注入攻击

### 混合数据的危险

	{
	    "mydictionary" :
	    {
	        "foo" : "Computer jargon",
	        "bar" : "More computer jargon"
	    }
	}
	
	Term: baz
	Definition: Still more computer jargon", "naughtyword": "A word you should not say
	
	{
	    "mydictionary" :
	    {
	        "foo" : "Computer jargon",
	        "bar" : "More computer jargon",
	        "baz" : "Still more computer jargon", "naughtyword": "A word you should not say"
	    }
	}

### SQL 注入

	INSERT INTO users (name, description) VALUES ("John Doe", "A really hoopy frood.");

	joe", "somebody"); DROP TABLE users; --


	INSERT INTO users (name, description) VALUES ("joe", "somebody"); DROP TABLE users; --", "A really hoopy frood.");

	INSERT INTO users (name, description) VALUES (?, ?);

### C 语言命令行之行和 shell 脚本

### URLs 引用

### HTML 和 XML 引用

> 重要：在某些特定环境下（比如在 JS 代码中），引用这些第五章节的代码可能不够。阅读《XSS 组织作弊列表》了解更多。

## 避免跨域脚本

# 附录A：安全开发检查表

本附录展示了一系列安全审查列表，你可以用它来帮你减少你的软件的安全威胁。本检查列表设计用来在软件开发阶段使用。如果你在开始编码之前通读了本章节，你可能会避免很多在完成编码的时候难于修正的安全陷阱。  
注意这个检查列表并不全面；

```
重要：所有的代码都应该在发布之前进行安全审核。
```

## 权限的使用

1. 尽可能的减少权限
2. 减少使用较高的权限，并且仅在特权助手当中使用
3. 尽可能使用 launchd
4. 避免使用编程的超级权限
5. 最小化代码必须运行在较高权限中
6. 永远不要使用较高权限运行一个 GUI 程序

## 数据，配置和临时文件

## 网络端口使用

## 审查日志

## 客户端-服务端鉴权

## 整型和缓存溢出

## 加密函数的使用

## 安装和加载

## 外部工具的使用和库

## 内核安全

# 附录B：第三方软件安全指南

## 尊重用户的隐私

## 提供更新信息

## 讲信息存储在适当的位置

## 避免请求超出需求的特权

## 实现安全开发实践

## 为安全做测试

## 帮助资源

# 词汇表

**AES 加密**高级标准加密的缩写。联邦标准信息处理过程（FIPS）的发布版本中 197 中有相关描述。AES 已经被美国政府应用在敏感信息，未分类信息的保护当中。  
**攻击者**指代某些故意的尝试让一个程序或操作系统做一些它本来不能做的事的人，比如允许攻击者执行代码或读取私有数据。  
**鉴权**一个人或其他实体（比如服务器）证明它是谁（或是什么）的过程。与授权相对。  
**授权**一个类似用户或服务器的实体获取权限来执行一个特权操作的过程。（）授权通常包含首次鉴权。参见「鉴权」。  
**缓冲区溢出**给一个内存缓冲区插入了过多数据，超过了它的缓冲区，会造成内存中的区域超过缓冲区的部分被重写。另参见《堆溢出》和《栈溢出》。  
**CDSA**常见数据安全架构的缩写。一个开放的软件标准基础设施，它提供了一个广泛的安全服务的集合，包括细粒度的访问权限，用户鉴权，加密和安全数据存储等。CDSA 又一个标准应用程序接口，叫做 CSSM。  
**CERT协调中心**互联网安全专家中心，位于软件工程研究所，是一个由联邦提供资金并开发的中心，由卡内基梅隆大学运营。CERT 是一个计算机紧急状态团队的首字母缩写。  
**证书**参见《数字证书》。  
**常见条件**由美国、加拿大、英国、法国、德国和荷兰政府制定的评估软件产品开发安全性的一系列安全过程。  
**CSSM**常见安全服务管理的缩写。CDSA 的公开应用程序接口。CSSM 还为实现安全服务的插件定义了一套接口用在特定操作系统喝硬件环境当中。  
**CVE**常见漏洞和弱点的缩写。放在 https://cve.mitre.org/ 上的一个安全漏洞的标准名称的字典。你可以在 CVE 上运行一个互联网搜索检索数字来阅读关于漏洞的详情。  
**数字证书**数据的集合，用来验证持有者的等同性。macOS 对数字证书支持 X.509 标准。  
**开发**一个程序或者示例代码，用来演示如何利用漏洞。  
**FileVault**一个macOS的功能，从系统安全选项中配置，用来加密根目录（在 10.7 及更高版本中用在用户目录）中的所有。  
**黑客**专家程序员——通常指具有非凡技能的人。大部分的黑客不会攻击其他的程序，某些发布漏洞的是为了强迫软件开发者修复缺陷。  
**堆**程序执行期间用来存储的一段内存区域。数据能够在堆的任意位置被写入或读取，向上增长（相对于高内存地址）。与栈相对。  
**堆溢出**在堆中的缓冲区溢出。  
**同形异意词**看起来相同，但有着不同 Unicode 值的字符，比如罗马字符 p 和俄罗斯文字都发音“r”。  
**整形溢出**整形缓存区溢出。  
**Kerberos**由MIT创建并通过网络提供验证的一种工业级协议。  
**钥匙串**macOS中的数据库，用来存储加密的密码，私钥喝其他秘密信息。还可以用来存储证书和其他用在密码学和校验中的非加密信息。  
**钥匙串访问工具**一个公开的 API，用来操作钥匙串中的数据。  
**钥匙串服务**一个公开的 API，可以用来操作钥匙串中的数据。  
**信任等级**用户对证书有效性的信心。一个证书的信任等级用来和信任政策一起回答「我这个行为是否应该信任证书？」这个问题。  
**不可否认性**让用户否认执行一项操作成为不可能的一种过程或技术（比如使用特定的信用卡号码）。  
**开放目录**由 macOS 提供的目录服务，用来安全的存储密码和用户鉴权信息。  
**权限**参见「特权」。  
**网络钓鱼**一种社会工程学技术，其中使用欺骗合法企业的电子邮件或网页来诱骗用户将个人数据和机密（例如密码）提供给具有恶意意图的人。  
**政策数据库**一个包含安全服务器规则集合的数据库，用来判断权限。  
**特权操作**一种需要特殊权限或特权的操作。  
**特权**访问一个文件或目录的类型（读、写、执行、穿过等等）准许一个用户或群组。  
**条件判断**两个事件顺序相冲突。  
**根库**恶意代码，通过在内核中运行，不仅可以接管系统的控制权，还可以掩盖其自身存在的所有证据。  
**根特权**在系统上使用不严格的权限执行任意操作。  
**信号**一种从一个基于Unix的操作系统（比如 macOS）的进程发送消息到另一个的过程。  
**社会工程**一种安全方面的应用，引诱用户放弃隐私或访问一个攻击者的电脑。  
**智能卡**一种和信用卡类似尺寸的塑料材质的卡，内部有微处理器嵌入和内存。一个智能卡能够存储和处理信息，包括密码，证书和密钥。  
**栈**一块内存的区域，用来给指定程序保留，以及控制程序流。数据被压入以及被移出是以后进先出的方式。栈向下增长（相对于低内存地址）。与堆相对。  
**栈溢出**栈缓存区溢出。  
**检验时间使用的时间(TOCTOU)**在一个攻击者生成、写入或者在一个程序检查和写入一个文件之间替换一个文件的时候的一种判断条件。  
**信任政策**一系列为合理使用鉴权指定特定信任等级的规则。比如，一个浏览器的信任政策可能表示一个证书是否过期了，用户应该在安全的打开一个网页服务之前及时授权。  
**安全隐患**指代这么一种功能：一个程序已经被写入——要么是已经设计好的错误或bug——这让它可能被黑客攻击。  